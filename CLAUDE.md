# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

### Build and Development
- Build entire solution: `dotnet build`
- Build specific project: `dotnet build src/Avalonia.GuideControl/Avalonia.GuideControl.csproj`
- Run demo application: `dotnet run --project src/Demo/Demo.csproj`
- Hot reload is available via HotAvalonia package in demo project

### Testing
- Run all tests: `dotnet test`
- Run specific test project: `dotnet test src/Avalonia.GuideControl.Tests/Avalonia.GuideControl.Tests.csproj`
- Run single test: `dotnet test --filter "FullyQualifiedName~TestMethodName"`
- Tests use xUnit framework with Avalonia.Headless.XUnit for UI testing

## Architecture

### Project Structure
This is an Avalonia UI library that provides guided tour controls with three main projects:

1. **Avalonia.GuideControl** - Main library containing:
   - `Controls/Mask.cs` - Canvas-based overlay for creating guided tours with geometric boolean operations
   - `Controls/GuideCard.cs` - Templated control for displaying guide content with navigation buttons
   - `Models/ControlInfo.cs` - Stores control metadata (type, name, position, tree structure)
   - `Models/Hole.cs` - Defines transparent areas in mask overlays with customizable borders/corners
   - `Models/Guide.cs` - Root container for complete guide flows with step resources and execution sequences
   - `Models/GuideStep.cs` - Individual guide step configuration with control paths and validation methods
   - `Models/GuideCardConfig.cs` - Guide card styling and content configuration
   - `AvaloniaUtils/` - Utilities for traversing visual/logic trees and extracting control information
   - `Extensions/` - Extension methods for simplified mask operations and card positioning
   - `GuideManager.cs` - Centralized guide flow execution and state management with async support

2. **Demo** - Sample application demonstrating the guide control functionality

3. **Avalonia.GuideControl.Tests** - xUnit tests with Avalonia headless testing support

### Key Components
- Uses Central Package Management (Directory.Packages.props) with Avalonia 11.3.6
- DependencyPropertyGenerator for generating Avalonia dependency properties  
- System.Text.Json source generators for AOT-friendly serialization
- CommunityToolkit.Mvvm (8.4.0) for MVVM patterns in development tools
- HotAvalonia (3.0.0) for hot reload support during development
- The Mask control creates overlay layers with geometry boolean operations for complex hole shapes
- ControlInfo captures metadata about controls including their position and tree hierarchy
- Hole model enables creating clickable/transparent regions within masks with corner radius and border support

### Core Architecture Details

#### Mask Control (`Controls/Mask.cs`)
- Canvas-based overlay that creates guided tour experiences
- Uses geometry boolean operations (Exclude) to create transparent holes in overlay
- Automatically positions itself as topmost layer using named Popup containers (`GuideTopmost_{timestamp}`)
- Supports hit testing control for interactive/non-interactive regions
- Implements IDisposable for proper resource cleanup
- Supports multiple simultaneous holes with complex geometry combinations

#### GuideCard Control (`Controls/GuideCard.cs`)
- TemplatedControl for displaying guide content with three navigation buttons (Previous/Next/Skip)
- Supports data binding through dependency properties generated by DependencyPropertyGenerator
- Event-driven architecture with both command patterns and routed events
- Fully customizable button text, visibility, and styling through CSS classes
- Template parts: PART_PreviousButton, PART_NextButton, PART_SkipButton

#### AvaloniaUtils System
- **AvaloniaUtils.cs**: Core utilities for visual tree traversal and topmost layer management
- **AvaloniaUtils.ControlInfo.cs**: Control metadata extraction and tree structure analysis with validation methods
- **AvaloniaUtils.VisualTree.cs**: Visual tree navigation using TypeName[index] path format
- **AvaloniaUtils.LogicTree.cs**: Logic tree operations and hierarchy traversal (similar structure to visual tree)
- **AvaloniaUtils.Measure.cs**: Control size measurement using hidden windows to avoid UI interference

#### GuideManager (`GuideManager.cs`)
- Centralized orchestrator for guide flow execution with async/await patterns
- Validation method dictionary mechanism for flexible step condition checking
- Support for preparation conditions (PreparedMethod) and completion conditions (FinishMethod)
- CancellationToken support for timeout and manual cancellation
- Event-driven validation state management
- Resource management with automatic cleanup

#### Extension Methods
- **CardExtension.cs**: Intelligent card positioning with nine-grid layout algorithm and boundary detection
- **GuideStepExtension.cs**: Step-to-visual conversion with hole creation from control paths
- **MaskExtensions.cs**: Simplified mask creation and management methods

### Key Patterns
- Topmost layer management using named Popup controls with timestamp suffixes
- Coordinate transformation between different visual tree levels using TransformToVisual
- Geometry-based clipping for creating transparent regions in overlays with boolean operations
- Extension methods for simplified mask operations and fluent APIs
- Factory pattern for control creation with configuration inheritance
- Strategy pattern for position calculation algorithms
- Event-driven validation mechanism with method dictionary lookup

### Modern Technology Integration
- **System.Text.Json Source Generators**: AOT-friendly serialization for guide configurations
- **Async/Await Patterns**: Modern asynchronous programming throughout the codebase
- **CancellationToken Support**: Proper cancellation handling for long-running operations
- **Dependency Property Generation**: Automatic property generation reducing boilerplate code
- **MVVM Architecture**: Complete MVVM implementation in development tools with CommunityToolkit.Mvvm

### Development Tools (`DevTools/`)
- **Tools.cs**: F1-key triggered development tool attachment to windows
- **RecordWindow.axaml.cs**: Visual recording window with drag support and transparency adjustment
- **Complete MVVM Architecture**: Multiple ViewModels for different aspects (BasicInfo, DefaultCard, StepEditor, StepsOrder)
- **Interactive Control Selection**: Alt+hover for control targeting, F4 for additional holes
- **JSON Configuration Management**: File operations for guide configuration persistence

### Performance Considerations
- Control measurement using hidden windows to avoid layout interference
- Path-based control lookup with caching recommendations for frequently used paths
- Geometry boolean operations for complex shape calculations
- Efficient visual tree traversal with type-based indexing
- Resource cleanup with IDisposable implementation throughout

### Thread Safety
- All UI operations must be performed on the UI thread (Dispatcher.UIThread)
- Async operations use proper cancellation token propagation
- Event handlers are designed to be thread-safe where applicable

### Development Guidelines
- Keep code clean and simple
- Avoid excessive abstraction unless necessary
- When implementing functions, don't add extra functions by default
- Comments should be in Chinese unless there are special requirements
- When encountering Chinese translations related to Hole, use Hole directly
- If I specify the completion of a certain method, implement it using the optimal solution, and do not add additional methods and properties unless necessary
- Follow modern C# patterns: nullable reference types, pattern matching, records where appropriate
- Use dependency injection patterns in development tools
- Implement proper resource disposal patterns

### Solution Structure
- Uses Visual Studio's new solution format (.slnx) for simplified project management
- Central package management ensures consistent dependency versions across all projects
- Solution includes configuration files in root folder for build and package management